<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu en JavaScript</title>
    <style>
        canvas {
            display: block;
            margin: 0 auto;
            background: url('img/background.png') no-repeat center center;
            background-size: cover;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Configuration du canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // Initial resize

        // Chargement des images
        const playerImage = new Image();
        playerImage.src = 'img/player.png';

        const goodItemImage = new Image();
        goodItemImage.src = 'img/good_item.png';

        const badItemImage = new Image();
        badItemImage.src = 'img/bad_item.png';

        const worseItemImage = new Image();
        worseItemImage.src = 'img/worse_item.png';

        const imagesLoaded = new Promise((resolve) => {
            let images = [playerImage, goodItemImage, badItemImage, worseItemImage];
            let loadedCount = 0;
            images.forEach(image => {
                image.onload = () => {
                    loadedCount++;
                    if (loadedCount === images.length) {
                        resolve();
                    }
                };
            });
        });

        // Variables du jeu
        let playerSize = 50;
        let playerPos = { x: canvas.width / 2, y: canvas.height - playerSize };
        let items = [];
        let itemSize = 50;
        let fallSpeed = 10;
        let score = 0;
        let maxItems = 40;
        let specialItemAdded = false;
        let gameDuration = 60000; // 1 minute
        let startTime = Date.now();

        // Gestion des scores
        function loadScores() {
            return JSON.parse(localStorage.getItem('scores') || '[]');
        }

        function saveScore(newScore) {
            let scores = loadScores();
            scores.push(newScore);
            scores.sort((a, b) => b - a);
            scores = scores.slice(0, 10);
            localStorage.setItem('scores', JSON.stringify(scores));
        }

        function displayLeaderboard() {
            let scores = loadScores();
            ctx.fillStyle = '#FFF';
            ctx.font = '24px monospace';
            let y = 100;
            scores.forEach((score, index) => {
                ctx.fillText(`${index + 1}. Score: ${score}`, 100, y);
                y += 30;
            });
        }

        function dropItems(timeLeft) {
            if (timeLeft > 2) {
                if (items.length < maxItems && Math.random() < 0.1) {
                    let draw = Math.random() * 100;
                    let itemImage, points;
                    if (draw <= 10) {
                        itemImage = worseItemImage;
                        points = -3;
                    } else if (draw <= 25) {
                        itemImage = badItemImage;
                        points = -1;
                    } else {
                        itemImage = goodItemImage;
                        points = 1;
                    }
                    let itemPos = { x: Math.random() * (canvas.width - itemSize), y: 0, image: itemImage, points: points };
                    items.push(itemPos);
                }
            } else if (timeLeft === 2 && !specialItemAdded) {
                let itemPos = { x: Math.random() * (canvas.width - itemSize), y: 0, image: goodItemImage, points: 5 };
                items.push(itemPos);
                specialItemAdded = true;
            }
        }

        function drawItems() {
            items.forEach(item => {
                ctx.drawImage(item.image, item.x, item.y, itemSize, itemSize);
            });
        }

        function updateItemPositions() {
            items = items.filter(item => item.y <= canvas.height);
            items.forEach(item => {
                item.y += fallSpeed;
            });
        }

        function collisionCheck() {
            let playerRect = { x: playerPos.x, y: playerPos.y, width: playerSize, height: playerSize };
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                let itemRect = { x: item.x, y: item.y, width: itemSize, height: itemSize };
                if (playerRect.x < itemRect.x + itemRect.width &&
                    playerRect.x + playerRect.width > itemRect.x &&
                    playerRect.y < itemRect.y + itemRect.height &&
                    playerRect.height + playerRect.y > itemRect.y) {
                    score += item.points;
                    items.splice(i, 1);
                }
            }
        }

        function gameLoop() {
            let currentTime = Date.now();
            let timeLeft = Math.floor((gameDuration - (currentTime - startTime)) / 1000);

            if (timeLeft <= 0) {
                saveScore(score);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                displayLeaderboard();
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            dropItems(timeLeft);
            updateItemPositions();
            collisionCheck();
            drawItems();

            ctx.drawImage(playerImage, playerPos.x, playerPos.y, playerSize, playerSize);
            ctx.font = '35px monospace';
            ctx.fillStyle = '#000';
            ctx.fillText(`Score: ${score}`, 20, 40);
            ctx.fillText(`Time: ${timeLeft}s`, canvas.width - 150, 40);

            requestAnimationFrame(gameLoop);
        }

        // Gestion des événements de la souris
        canvas.addEventListener('mousemove', (e) => {
            playerPos.x = e.clientX - playerSize / 2;
        });

        imagesLoaded.then(() => {
            gameLoop();
        });

    </script>
</body>
</html>
